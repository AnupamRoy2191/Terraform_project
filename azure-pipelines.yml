trigger:
- main

parameters:

- name: environment
  displayName: Select environment to create infra resources
  type: string
  values:
    - uat
    - prod

- name: action
  displayName: Select Action - Apply or destroy resources
  type: string
  values:
    - apply
    - destroy

variables:
    - group: terraform-secrets

stages:
  - stage: TerraformApply
    displayName: Terraform plan deployment resource
    condition: eq('${{ parameters.action }}', 'apply')
    jobs:
      - job: init_plan
        displayName: Terraform plan deployment
        pool: default
        steps:
          - checkout: self
          - script: |
              terraform init
              terraform workspace select ${{ parameters.environment }} || terraform workspace new ${{ parameters.environment }}
              terraform plan -var-file=./envs/${{ parameters.environment }}/${{ parameters.environment }}-vars.tfvars
            displayName: 'Terraform plan deployment'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)

      - job: apply
        displayName: Terraform apply deployment
        pool: default
        dependsOn: init_plan
        condition: succeeded()
        steps:
          - checkout: self
          - script: |
              terraform init
              terraform workspace select ${{ parameters.environment }}
              terraform apply -var-file=./envs/${{ parameters.environment }}/${{ parameters.environment }}-vars.tfvars -auto-approve
            displayName: 'Terraform apply deployment'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)

  - stage: TerraformDestroy
    displayName: Terraform destroy deployment
    condition: eq('${{ parameters.action }}', 'destroy')
    jobs:
      - job: destroy
        displayName: Terraform destroy deployment
        pool: default
        steps:
          - checkout: self
          - script: |
              terraform init
              terraform workspace select ${{ parameters.environment }}
              terraform destroy -var-file=./envs/${{ parameters.environment }}/${{ parameters.environment }}-vars.tfvars -auto-approve
            displayName: 'Terraform destroy deployment'
            env:
              ARM_CLIENT_ID: $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(ARM_TENANT_ID)



  # - stage: TerraformInitPlan
  #   displayName: Terraform Init & Plan
  #   jobs:
  #     - job: init_plan
  #       displayName: Terraform Init & Plan
  #       pool: default
  #       steps:
  #         - checkout: self
  #         - script: |
  #             terraform init
  #             terraform workspace select ${{ parameters.environment }} || terraform workspace new ${{ parameters.environment }}
  #             terraform plan -var-file=envs/"${{ parameters.environment }}/${{ parameters.environment }}-vars.tfvars" -out=tfplan
  #           displayName: 'Terraform Init & Plan'

  # - stage: TerraformApply
  #   displayName: Terraform Apply
  #   dependsOn: TerraformInitPlan
  #   condition: succeeded()
  #   jobs:
  #     - job: apply
  #       displayName: Terraform Apply
  #       pool: self-host-agent
  #       steps:
  #         - checkout: self

  #         - task: UsePythonVersion@0
  #           inputs:
  #             versionSpec: '3.x'

  #         - task: TerraformInstaller@1
  #           inputs:
  #             terraformVersion: '1.5.7'

  #         - script: |
  #             terraform init
  #             terraform workspace select ${{ parameters.environment }}
  #             terraform apply -auto-approve tfplan
  #           displayName: 'Terraform Apply'

  # - stage: TerraformDestroy
  #   displayName: Terraform Destroy
  #   condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
  #   jobs:
  #     - job: destroy
  #       displayName: Terraform Destroy
  #       pool: self-host-agent
  #       steps:
  #         - checkout: self

  #         - task: UsePythonVersion@0
  #           inputs:
  #             versionSpec: '3.x'

  #         - task: TerraformInstaller@1
  #           inputs:
  #             terraformVersion: '1.5.7'

  #         - script: |
  #             terraform init
  #             terraform workspace select ${{ parameters.environment }}
  #             terraform destroy -auto-approve -var-file="${{ parameters.environment }}.tfvars"
  #           displayName: 'Terraform Destroy'
